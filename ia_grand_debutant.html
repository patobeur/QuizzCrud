<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Test de positionnement ‚Äì IA g√©n√©rative (niveau modeste)</title>
		<script src="https://cdn.tailwindcss.com"></script>
	</head>
	<body class="bg-gray-100 text-gray-900">
		<div class="max-w-3xl mx-auto p-4 md:p-6">
			<header class="mb-6">
				<h1 class="text-2xl md:text-3xl font-bold"
					>Test de positionnement ‚Äì IA g√©n√©rative (Grand(e)
					d√©butant(e))</h1
				>
				<p class="text-sm text-gray-700 mt-1">
					20 questions. R√©pondez, cliquez sur <strong>Valider</strong> pour
					verrouiller votre r√©ponse et voir le feedback, puis
					<strong>Suivant</strong>.
				</p>
			</header>

			<!-- Carte principale -->
			<div class="bg-white rounded-2xl shadow p-5 md:p-6">
				<!-- Progression -->
				<div class="mb-4">
					<div
						class="flex items-center justify-between text-sm text-gray-600">
						<span id="progress-label">Question 1 / 20</span>
						<span id="score-label">Score : 0</span>
					</div>
					<div class="w-full bg-gray-200 h-2 rounded mt-2">
						<div
							id="progress-bar"
							class="bg-emerald-500 h-2 rounded"
							style="width: 5%"></div>
					</div>
				</div>

				<!-- Th√®me -->
				<div
					id="theme"
					class="text-xs uppercase tracking-wide text-gray-500 mb-2"></div>

				<!-- Question -->
				<h2
					id="question"
					class="text-lg md:text-xl font-semibold mb-2"></h2>
				<div id="multi-help" class="hidden mb-3 text-xs text-gray-600">
					Plusieurs r√©ponses peuvent √™tre correctes. S√©lectionnez toutes
					les bonnes r√©ponses.
				</div>

				<!-- Options / Widgets -->
				<form id="options" class="space-y-2 mb-4"></form>

				<!-- Feedback -->
				<div id="feedback" class="hidden p-3 rounded-lg text-sm"></div>

				<!-- Pertinence -->
				<details id="relevance" class="hidden mt-2">
					<summary class="cursor-pointer text-sm text-gray-700 font-medium"
						>Pourquoi cette question est pertinente ?</summary
					>
					<div
						class="mt-1 text-sm text-gray-600"
						id="relevance-text"></div>
				</details>

				<!-- Contr√¥les -->
				<div class="mt-6 flex flex-wrap gap-2">
					<button
						id="prev-btn"
						class="px-4 py-2 rounded-xl border text-sm disabled:opacity-40"
						type="button"
						>Pr√©c√©dent</button
					>
					<button
						id="validate-btn"
						class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm"
						type="button"
						>Valider</button
					>
					<button
						id="next-btn"
						class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm disabled:opacity-40"
						type="button"
						disabled
						>Suivant</button
					>
					<button
						id="finish-btn"
						class="ml-auto px-4 py-2 rounded-xl bg-gray-900 text-white text-sm hidden"
						type="button"
						>Voir l‚Äôavis final</button
					>
				</div>
			</div>

			<!-- R√©sultat final -->
			<div
				id="final"
				class="hidden bg-white rounded-2xl shadow p-5 md:p-6 mt-6">
				<h3 class="text-xl font-semibold mb-2">Avis final</h3>
				<p id="final-summary" class="mb-4 text-gray-800"></p>
				<ul
					id="final-flags"
					class="list-disc pl-6 text-sm text-gray-700 mb-4"></ul>
				<div id="recos" class="p-4 rounded-xl"></div>

				<details class="mt-6">
					<summary class="cursor-pointer text-sm text-gray-700 font-medium"
						>Voir le r√©cap par question</summary
					>
					<div id="recap" class="mt-3 space-y-3"></div>
				</details>

				<div class="mt-6 flex gap-2">
					<button
						id="restart-btn"
						class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm"
						type="button"
						>Recommencer</button
					>
					<button
						id="export-btn"
						class="px-4 py-2 rounded-xl border text-sm"
						type="button"
						>Exporter mes r√©ponses (JSON)</button
					>
				</div>
			</div>
		</div>

		<script>
			/** ==============================================================
			 *  BANQUE DE QUESTIONS ‚Äì IA g√©n√©rative (niveau grand d√©butant)
			 *  Types support√©s : single, multi, select, multiselect, toggle, range, ranking (drag&drop), image
			 *  Points >= 0 (pas de malus). Feedback personnalis√© (correct/partial/incorrect).
			 *  ============================================================== */

			const QUESTIONS = [
				// Th√®me 1 ‚Äî D√©couverte & rep√®res (4)
				{
					id: "TDB01",
					theme: "D√©couverte",
					question:
						"Avez-vous au moins un compte sur un service d‚ÄôIA (ex. ChatGPT, Copilot) ?",
					selectionType: "toggle", // 0=Non, 1=Oui
					options: [
						{ label: "Non", points: 1 },
						{ label: "Oui", points: 2 },
					],
					feedback_correct:
						"Parfait ! Vous pourrez pratiquer imm√©diatement.",
					feedback_partial: "Super, premi√®re √©tape d√©j√† franchie.",
					feedback_incorrect:
						"Aucun souci : on vous guidera pour cr√©er un acc√®s.",
					relevance:
						"Situe votre point de d√©part pour l‚Äôacc√®s aux outils.",
				},
				{
					id: "TDB02",
					theme: "D√©couverte",
					question: "Un chatbot d‚ÄôIA sert principalement √†‚Ä¶",
					selectionType: "single",
					options: [
						{
							label: "R√©pondre √† des consignes en langage naturel",
							points: 4,
						},
						{ label: "Remplacer totalement les humains", points: 0 },
						{ label: "Installer des logiciels", points: 0 },
					],
					feedback_correct:
						"Exact : on lui parle, il r√©pond √† partir de votre consigne.",
					feedback_partial: "On vise une interaction en langage naturel.",
					feedback_incorrect:
						"Un chatbot ne remplace pas un humain ni n‚Äôinstalle des applis.",
					relevance: "Clarifie l‚Äôobjectif de base d‚Äôun assistant IA.",
				},
				{
					id: "TDB03",
					theme: "D√©couverte",
					question:
						"Choisissez l‚Äôexemple de consigne (prompt) le plus clair pour d√©buter :",
					selectionType: "image",
					options: [
						{
							label: "¬´ R√©sume ce texte en 2 puces ¬ª",
							points: 4,
							emoji: "üîπ",
						},
						{ label: "¬´ Fais au mieux stp ¬ª", points: 0, emoji: "ü§∑" },
						{
							label: "¬´ √âcris tout ce qui te vient ¬ª",
							points: 1,
							emoji: "üåÄ",
						},
					],
					feedback_correct:
						"Tr√®s bien : demande pr√©cise + format attendu.",
					feedback_partial:
						"Plus c‚Äôest vague, plus la r√©ponse sera al√©atoire.",
					feedback_incorrect: "Soyez pr√©cis sur l‚Äôobjectif et le format.",
					relevance: "Montre l‚Äôimportance d‚Äôun prompt simple et cadr√©.",
				},
				{
					id: "TDB04",
					theme: "D√©couverte",
					question: "O√π √©crit-on le prompt dans un chatbot ?",
					selectionType: "select",
					options: [
						{
							label: "Dans la zone de saisie (champ de message)",
							points: 4,
						},
						{
							label: "Dans la barre d‚Äô√©tat en bas de Windows",
							points: 0,
						},
						{ label: "Dans les param√®tres du navigateur", points: 0 },
					],
					feedback_correct:
						"Oui : le prompt se tape dans le champ de message du chat.",
					feedback_partial:
						"C‚Äôest bien la zone de saisie du chat qu‚Äôon utilise.",
					feedback_incorrect:
						"On ne passe pas par la barre d‚Äô√©tat ou les param√®tres.",
					relevance: "Assure un rep√®re d‚Äôinterface tr√®s concret.",
				},

				// Th√®me 2 ‚Äî S√©curit√© & hygi√®ne (5)
				{
					id: "TDB05",
					theme: "S√©curit√©",
					question:
						"√âvitez de coller dans un chatbot (plusieurs r√©ponses possibles) :",
					selectionType: "multi",
					options: [
						{ label: "Mots de passe", points: 3 },
						{ label: "N¬∞ de carte bancaire", points: 3 },
						{
							label: "Donn√©es personnelles identifiables (ex. NIR)",
							points: 3,
						},
						{ label: "Horaire de d√©jeuner", points: 0 },
					],
					feedback_correct:
						"Parfait : pas de secrets ni d‚Äôinfos sensibles.",
					feedback_partial:
						"Bien. Soyez rigoureux sur les donn√©es sensibles.",
					feedback_incorrect:
						"Prot√©gez vos informations : pas de secrets/confidentiel.",
					relevance: "Ancre un r√©flexe de confidentialit√© simple.",
				},
				{
					id: "TDB06",
					theme: "S√©curit√©",
					question: "Demander une action ill√©gale √† l‚ÄôIA, c‚Äôest‚Ä¶",
					selectionType: "toggle",
					options: [
						{ label: "Acceptable", points: 0 },
						{ label: "Interdit", points: 4 },
					],
					feedback_correct:
						"Exact : c‚Äôest proscrit et contraire √† l‚Äô√©thique.",
					feedback_partial: "La bonne r√©ponse : ¬´ Interdit ¬ª. ",
					feedback_incorrect: "C‚Äôest interdit et dangereux.",
					relevance: "Rappelle une limite non n√©gociable.",
				},
				{
					id: "TDB07",
					theme: "S√©curit√©",
					question:
						"Bonnes pratiques de confidentialit√© (plusieurs r√©ponses possibles) :",
					selectionType: "multi",
					options: [
						{ label: "Anonymiser les donn√©es si besoin", points: 2 },
						{
							label: "V√©rifier les param√®tres de conservation des chats",
							points: 2,
						},
						{
							label: "Partager des secrets internes pour de meilleures r√©ponses",
							points: 0,
						},
						{
							label: "Limiter l‚Äôextrait coll√© au strict n√©cessaire",
							points: 2,
						},
					],
					feedback_correct:
						"Tr√®s bien : anonymisez, param√©trez, limitez le contenu coll√©.",
					feedback_partial:
						"Bien. Ajoutez l‚Äôanonymisation et la parcimonie.",
					feedback_incorrect:
						"R√©duisez ce que vous collez et anonymisez au besoin.",
					relevance: "Hygi√®ne de base pour travailler sereinement.",
				},
				{
					id: "TDB08",
					theme: "S√©curit√©",
					question: "Quand citer des sources ?",
					selectionType: "single",
					options: [
						{
							label: "Quand on partage des infos factuelles issues/valid√©es via l‚ÄôIA",
							points: 4,
						},
						{ label: "Jamais", points: 0 },
						{ label: "Uniquement pour des images", points: 1 },
					],
					feedback_correct:
						"Exact : sourcer et v√©rifier les faits est souhaitable.",
					feedback_partial: "Mieux vaut sourcer les contenus factuels.",
					feedback_incorrect: "Pensez √† citer et v√©rifier.",
					relevance: "Encourage un usage responsable.",
				},
				{
					id: "TDB09",
					theme: "S√©curit√©",
					question: "Si l‚ÄôIA propose une r√©ponse m√©dicale s√©rieuse, je‚Ä¶",
					selectionType: "single",
					options: [
						{ label: "Consulte un professionnel de sant√©", points: 4 },
						{ label: "Applique sans v√©rifier", points: 0 },
						{ label: "Demande √† un ami", points: 1 },
					],
					feedback_correct: "Parfait : l‚Äôavis d‚Äôun pro est indispensable.",
					feedback_partial: "Un pro reste la bonne r√©f√©rence.",
					feedback_incorrect: "Ne pas appliquer sans avis m√©dical.",
					relevance: "Distingue usages ludiques vs d√©cisions critiques.",
				},

				// Th√®me 3 ‚Äî Prompts tout-d√©butant (5)
				{
					id: "TDB10",
					theme: "Prompts",
					question:
						"Ce qui aide un prompt simple (plusieurs r√©ponses possibles) :",
					selectionType: "multi",
					options: [
						{ label: "Dire l‚Äôobjectif en une phrase", points: 2 },
						{
							label: "Pr√©ciser le format de sortie (ex. 3 puces)",
							points: 2,
						},
						{
							label: "Indiquer le public/ton (ex. d√©butant, neutre)",
							points: 2,
						},
						{ label: "Rester volontairement vague", points: 0 },
					],
					feedback_correct:
						"Excellent : objectif, format, ton = r√©ponses plus utiles.",
					feedback_partial:
						"Bien. Soyez un peu plus pr√©cis pour gagner en qualit√©.",
					feedback_incorrect: "Plus de clart√© ‚Üí meilleures r√©ponses.",
					relevance: "Pose une structure minimaliste et efficace.",
				},
				{
					id: "TDB11",
					theme: "Prompts",
					question:
						"√Ä quel point vous √™tes √† l‚Äôaise pour expliquer ce que vous voulez √† l‚ÄôIA ?",
					selectionType: "range",
					range: {
						min: 0,
						max: 10,
						step: 1,
						bands: [
							{ min: 0, max: 3, points: 1 },
							{ min: 4, max: 7, points: 2 },
							{ min: 8, max: 10, points: 3 },
						],
					},
					options: [],
					feedback_correct: "G√©nial ! Vous pourrez aller vite.",
					feedback_partial:
						"Parfait pour commencer : on progressera par petits pas.",
					feedback_incorrect:
						"Pas grave : on vous donnera des mod√®les de prompts.",
					relevance: "Mesure votre confort pour guider la machine.",
				},
				{
					id: "TDB12",
					theme: "Prompts",
					question: "Ordonnez ces √©tapes (glisser-d√©poser) :",
					selectionType: "ranking",
					options: [
						{ label: "Dire l‚Äôobjectif" },
						{ label: "Donner un peu de contexte" },
						{ label: "Pr√©ciser le format de sortie" },
						{ label: "Relire puis envoyer" },
					],
					ranking: { correctOrder: [0, 1, 2, 3], pointsPerItem: 1 },
					feedback_correct: "Top : objectif ‚Üí contexte ‚Üí format ‚Üí envoi.",
					feedback_partial:
						"Bonne logique globale, peaufinez l‚Äôordre exact.",
					feedback_incorrect:
						"Astuce : objectif, contexte, format, puis envoi.",
					relevance: "Cr√©e un automatisme simple de r√©daction de prompt.",
				},
				{
					id: "TDB13",
					theme: "Prompts",
					question: "Pour ¬´ R√©sume en 2 puces ¬ª, quel rendu convient ?",
					selectionType: "image",
					options: [
						{ label: "‚Ä¢ Id√©e 1 ‚Ä¢ Id√©e 2", points: 4, emoji: "üîπ" },
						{ label: "Un paragraphe continu", points: 0, emoji: "üìÑ" },
						{ label: "Une liste de 10 puces", points: 1, emoji: "üìã" },
					],
					feedback_correct: "Exact : deux puces, concises et lisibles.",
					feedback_partial: "Visez vraiment 2 puces, pas plus.",
					feedback_incorrect: "Demande = 2 puces ; pas un pav√©.",
					relevance: "Aligne sortie et format demand√©.",
				},
				{
					id: "TDB14",
					theme: "Prompts",
					question: "Obtenir une traduction simple, c‚Äôest plut√¥t‚Ä¶",
					selectionType: "select",
					options: [
						{
							label: "√âcrire ¬´ Traduis en fran√ßais : ¬ª + le texte",
							points: 4,
						},
						{ label: "Coller le texte sans rien dire", points: 0 },
						{ label: "Demander un roman", points: 0 },
					],
					feedback_correct: "Oui : formule explicite et directe.",
					feedback_partial: "Soyez explicite pour une meilleure sortie.",
					feedback_incorrect: "Dites clairement ¬´ Traduis‚Ä¶ ¬ª.",
					relevance: "Encourage des requ√™tes claires et courtes.",
				},

				// Th√®me 4 ‚Äî Usages raisonnables (4)
				{
					id: "TDB15",
					theme: "Usages",
					question:
						"Usages adapt√©s pour d√©buter (plusieurs r√©ponses possibles) :",
					selectionType: "multiselect",
					options: [
						{ label: "Brainstorming / trouver des id√©es", points: 2 },
						{ label: "Reformulation / correction rapide", points: 2 },
						{ label: "Traduction simple", points: 2 },
						{ label: "Faire mes devoirs √† ma place", points: 0 },
					],
					feedback_correct:
						"Tr√®s bien : commencez par des usages simples et guid√©s.",
					feedback_partial: "Bien. √âvitez les usages non-√©thiques.",
					feedback_incorrect:
						"Privil√©giez id√©es, reformulation, traduction simple.",
					relevance: "Cadre des cas d‚Äôusage raisonnables.",
				},
				{
					id: "TDB16",
					theme: "Usages",
					question:
						"Le bon niveau d‚Äôattente vis-√†-vis d‚Äôun chatbot, c‚Äôest‚Ä¶",
					selectionType: "single",
					options: [
						{
							label: "De l‚Äôaide, des id√©es, des √©bauches (pas la v√©rit√© absolue)",
							points: 4,
						},
						{ label: "Des r√©ponses officielles garanties", points: 0 },
						{ label: "Une boule de cristal", points: 0 },
					],
					feedback_correct: "Exact : l‚ÄôIA propose des pistes, √† valider.",
					feedback_partial:
						"L‚ÄôIA aide, mais n‚Äôest pas une v√©rit√© officielle.",
					feedback_incorrect: "√âvitez d‚Äôattendre une garantie absolue.",
					relevance: "Ajuste les attentes pour √©viter les d√©ceptions.",
				},
				{
					id: "TDB17",
					theme: "Usages",
					question:
						"Formats faciles √† r√©utiliser (plusieurs r√©ponses possibles) :",
					selectionType: "multi",
					options: [
						{ label: "Liste √† puces", points: 2 },
						{ label: "Tableau simple", points: 2 },
						{ label: "JSON simple", points: 2 },
						{ label: "PDF tr√®s styl√©", points: 0 },
					],
					feedback_correct:
						"Parfait : listes, tableaux, JSON sont pratiques.",
					feedback_partial: "Bien. Privil√©giez des formats simples.",
					feedback_incorrect: "Visez des sorties faciles √† copier/coller.",
					relevance: "Facilite l‚Äôint√©gration dans vos outils.",
				},
				{
					id: "TDB18",
					theme: "Usages",
					question: "La ¬´ temp√©rature ¬ª contr√¥le surtout‚Ä¶",
					selectionType: "single",
					options: [
						{
							label: "La cr√©ativit√©/variabilit√© des r√©ponses",
							points: 4,
						},
						{ label: "La vitesse de votre connexion", points: 0 },
						{
							label: "Le t√©l√©chargement de donn√©es d‚Äôentra√Ænement",
							points: 0,
						},
					],
					feedback_correct:
						"Oui : plus haut = plus cr√©atif/vari√© (moins pr√©visible).",
					feedback_partial:
						"C‚Äôest un r√©glage qui joue sur la variabilit√©.",
					feedback_incorrect:
						"La temp√©rature ne concerne ni r√©seau ni entra√Ænement.",
					relevance: "Donne un rep√®re sur un param√®tre fr√©quent.",
				},

				// Th√®me 5 ‚Äî V√©rification & attitude (2)
				{
					id: "TDB19",
					theme: "V√©rification",
					question:
						"V√©rifier une info donn√©e par l‚ÄôIA (plusieurs r√©ponses possibles) :",
					selectionType: "multi",
					options: [
						{ label: "Chercher des sources fiables", points: 2 },
						{ label: "Recouper avec plusieurs sites", points: 2 },
						{ label: "Tester soi-m√™me quand c‚Äôest possible", points: 2 },
						{ label: "Copier-coller sans v√©rifier", points: 0 },
					],
					feedback_correct: "Excellent : sourcer, recouper, tester.",
					feedback_partial:
						"Bien. Ajoutez du recoupement/test si possible.",
					feedback_incorrect: "Toujours v√©rifier avant de diffuser.",
					relevance: "Installe une hygi√®ne de v√©rification douce.",
				},
				{
					id: "TDB20",
					theme: "Attitude",
					question:
						"√ätes-vous pr√™t¬∑e √† reformuler/relancer si la 1re r√©ponse ne convient pas ?",
					selectionType: "toggle",
					options: [
						{ label: "Non", points: 1 },
						{ label: "Oui", points: 3 },
					],
					feedback_correct:
						"Super : la reformulation d√©bloque souvent la situation.",
					feedback_partial: "C‚Äôest la bonne posture pour progresser vite.",
					feedback_incorrect: "Relancer aide √† obtenir mieux, pas √† pas.",
					relevance: "Favorise une pratique d√©complex√©e et efficace.",
				},
			];

			/* ==============================================================
   LOGIQUE / ETAT
   ============================================================== */
			const state = {
				index: 0,
				validated: Array(QUESTIONS.length).fill(false),
				answers: Array(QUESTIONS.length).fill(null), // single: number | null ; multi: number[] | null ; select: number|null ; multiselect: number[]|null ; toggle: 0|1|null ; range: number|null ; ranking: number[]|null ; image: number|null
				pointsEarned: Array(QUESTIONS.length).fill(0),
				score: 0,
			};

			const els = {
				progressLabel: document.getElementById("progress-label"),
				scoreLabel: document.getElementById("score-label"),
				progressBar: document.getElementById("progress-bar"),
				theme: document.getElementById("theme"),
				question: document.getElementById("question"),
				multiHelp: document.getElementById("multi-help"),
				options: document.getElementById("options"),
				feedback: document.getElementById("feedback"),
				relevanceBox: document.getElementById("relevance"),
				relevanceText: document.getElementById("relevance-text"),
				prevBtn: document.getElementById("prev-btn"),
				validateBtn: document.getElementById("validate-btn"),
				nextBtn: document.getElementById("next-btn"),
				finishBtn: document.getElementById("finish-btn"),
				final: document.getElementById("final"),
				finalSummary: document.getElementById("final-summary"),
				finalFlags: document.getElementById("final-flags"),
				recos: document.getElementById("recos"),
				recap: document.getElementById("recap"),
				restartBtn: document.getElementById("restart-btn"),
				exportBtn: document.getElementById("export-btn"),
			};

			function setInputsDisabled(disabled) {
				[
					...els.options.querySelectorAll(
						"input, select, button, textarea"
					),
				].forEach((el) => (el.disabled = disabled));
				if (disabled) {
					els.options.classList.add("pointer-events-none");
				} else {
					els.options.classList.remove("pointer-events-none");
				}
				[...els.options.querySelectorAll("label,.card-choice")].forEach(
					(lab) => {
						lab.classList.toggle("opacity-60", disabled);
						lab.classList.toggle("cursor-not-allowed", disabled);
					}
				);
				// Ranking: d√©sactiver le drag
				els.options
					.querySelectorAll('[draggable="true"]')
					.forEach((n) => n.setAttribute("draggable", String(!disabled)));
			}

			function maxPointsForQuestion(q) {
				switch (q.selectionType) {
					case "single":
					case "select":
					case "image":
						return Math.max(...q.options.map((o) => o.points ?? 0));
					case "multi":
					case "multiselect":
						return q.options.reduce(
							(s, o) => s + Math.max(0, o.points ?? 0),
							0
						);
					case "toggle":
						return Math.max(...q.options.map((o) => o.points ?? 0));
					case "range":
						return Math.max(
							...(q.range?.bands ?? []).map((b) => b.points)
						);
					case "ranking": {
						const p = q.ranking?.pointsPerItem ?? 1;
						const n = (q.options ?? []).length;
						return p * n;
					}
					default:
						return 0;
				}
			}
			const TOTAL_MAX = QUESTIONS.reduce(
				(acc, q) => acc + maxPointsForQuestion(q),
				0
			);

			/* ---------- Rendu ---------- */
			function renderQuestion() {
				const i = state.index;
				const q = QUESTIONS[i];

				els.progressLabel.textContent = `Question ${i + 1} / ${
					QUESTIONS.length
				}`;
				const pct = Math.max(5, Math.round((i / QUESTIONS.length) * 100));
				els.progressBar.style.width = `${pct}%`;

				els.theme.textContent = q.theme;
				els.question.innerHTML = q.question;

				els.multiHelp.classList.toggle(
					"hidden",
					!["multi", "multiselect"].includes(q.selectionType)
				);

				// Options
				els.options.innerHTML = "";
				const saved = state.answers[i];

				if (q.selectionType === "single") {
					q.options.forEach((opt, idx) => {
						const id = `q${i}_opt${idx}`;
						const checked = saved === idx ? "checked" : "";
						els.options.insertAdjacentHTML(
							"beforeend",
							`
        <label for="${id}" class="flex items-start gap-3 p-3 border rounded-xl hover:bg-gray-50 cursor-pointer">
          <input ${checked} id="${id}" name="q${i}" type="radio" value="${idx}" class="mt-1" />
          <span>${opt.label}</span>
        </label>
      `
						);
					});
				} else if (q.selectionType === "multi") {
					const arr = Array.isArray(saved) ? saved : [];
					q.options.forEach((opt, idx) => {
						const id = `q${i}_opt${idx}`;
						const checked = arr.includes(idx) ? "checked" : "";
						els.options.insertAdjacentHTML(
							"beforeend",
							`
        <label for="${id}" class="flex items-start gap-3 p-3 border rounded-xl hover:bg-gray-50 cursor-pointer">
          <input ${checked} id="${id}" name="q${i}" type="checkbox" value="${idx}" class="mt-1" />
          <span>${opt.label}</span>
        </label>
      `
						);
					});
				} else if (q.selectionType === "select") {
					const current = Number.isInteger(saved) ? saved : null;
					const opts = q.options
						.map(
							(opt, idx) =>
								`<option value="${idx}" ${
									current === idx ? "selected" : ""
								}>${opt.label}</option>`
						)
						.join("");
					els.options.innerHTML = `
      <label class="block text-sm font-medium text-gray-700 mb-1">Choisissez une option</label>
      <select class="w-full border rounded-xl p-2">
        <option value="" ${
				current === null ? "selected" : ""
			} disabled>‚Äî S√©lectionnez ‚Äî</option>
        ${opts}
      </select>
    `;
				} else if (q.selectionType === "multiselect") {
					const arr = Array.isArray(saved) ? saved : [];
					const opts = q.options
						.map(
							(opt, idx) =>
								`<option value="${idx}" ${
									arr.includes(idx) ? "selected" : ""
								}>${opt.label}</option>`
						)
						.join("");
					els.options.innerHTML = `
      <label class="block text-sm font-medium text-gray-700 mb-1">S√©lection multiple (Ctrl/Cmd ou Maj pour plusieurs)</label>
      <select multiple size="${Math.min(
			8,
			q.options.length
		)}" class="w-full border rounded-xl p-2">
        ${opts}
      </select>
    `;
				} else if (q.selectionType === "toggle") {
					const isOn = saved === 1;
					els.options.innerHTML = `
      <label class="flex items-center gap-3 select-none">
        <input id="toggle_${i}" type="checkbox" class="sr-only" ${
						isOn ? "checked" : ""
					}>
        <span data-role="track" class="relative inline-flex h-6 w-11 items-center rounded-full transition ${
				isOn ? "bg-emerald-500" : "bg-gray-300"
			}">
          <span data-role="knob" class="inline-block h-5 w-5 transform rounded-full bg-white shadow transition ${
					isOn ? "translate-x-5" : "translate-x-1"
				}"></span>
        </span>
        <span data-role="toggle-label">${
				isOn ? q.options[1].label : q.options[0].label
			}</span>
      </label>
    `;
					const t = document.getElementById(`toggle_${i}`);
					const track = els.options.querySelector('[data-role="track"]');
					const knob = els.options.querySelector('[data-role="knob"]');
					const text = els.options.querySelector(
						'[data-role="toggle-label"]'
					);
					function sync() {
						track.classList.toggle("bg-emerald-500", t.checked);
						track.classList.toggle("bg-gray-300", !t.checked);
						knob.classList.toggle("translate-x-5", t.checked);
						knob.classList.toggle("translate-x-1", !t.checked);
						text.textContent = t.checked
							? q.options[1].label
							: q.options[0].label;
					}
					t?.addEventListener("change", sync);
				} else if (q.selectionType === "range") {
					const val =
						typeof saved === "number"
							? saved
							: Math.round((q.range.min + q.range.max) / 2);
					els.options.innerHTML = `
      <div class="flex items-center gap-3">
        <input id="range_${i}" type="range" min="${q.range.min}" max="${q.range.max}" step="${q.range.step}" value="${val}" class="w-full">
        <span id="range_val_${i}" class="w-10 text-right text-sm font-medium">${val}</span>
      </div>
    `;
					const r = document.getElementById(`range_${i}`);
					const out = document.getElementById(`range_val_${i}`);
					r?.addEventListener("input", () => (out.textContent = r.value));
				} else if (q.selectionType === "ranking") {
					const order = Array.isArray(saved)
						? saved
						: q.options.map((_, idx) => idx);
					const list = document.createElement("ul");
					list.className = "space-y-2";
					order.forEach((idx) => {
						const li = document.createElement("li");
						li.className = "p-3 border rounded-xl bg-gray-50 cursor-move";
						li.setAttribute("draggable", "true");
						li.dataset.idx = String(idx);
						li.innerHTML = `<span class="text-sm">${q.options[idx].label}</span>`;
						list.appendChild(li);
					});
					els.options.appendChild(list);

					// DnD
					let dragging = null;
					list.addEventListener("dragstart", (e) => {
						dragging = e.target;
						e.target.classList.add("opacity-70");
					});
					list.addEventListener("dragend", (e) =>
						e.target.classList.remove("opacity-70")
					);
					list.addEventListener("dragover", (e) => {
						e.preventDefault();
						const after = [...list.querySelectorAll("li")].find((li) => {
							const rect = li.getBoundingClientRect();
							return e.clientY < rect.top + rect.height / 2;
						});
						if (!after) list.appendChild(dragging);
						else list.insertBefore(dragging, after);
					});
				} else if (q.selectionType === "image") {
					const current = Number.isInteger(saved) ? saved : null;
					const wrap = document.createElement("div");
					wrap.className = "grid grid-cols-1 sm:grid-cols-3 gap-3";
					q.options.forEach((opt, idx) => {
						const isSel = current === idx;
						const card = document.createElement("button");
						card.type = "button";
						card.className = `card-choice border rounded-xl p-4 text-left hover:shadow ${
							isSel ? "border-emerald-400 ring-2 ring-emerald-200" : ""
						}`;
						card.innerHTML = `
        <div class="text-3xl">${opt.emoji ?? "üß†"}</div>
        <div class="mt-2 text-sm">${opt.label}</div>
      `;
						card.addEventListener("click", () => {
							// unselect others
							wrap
								.querySelectorAll(".card-choice")
								.forEach((c) =>
									c.classList.remove(
										"border-emerald-400",
										"ring-2",
										"ring-emerald-200"
									)
								);
							card.classList.add(
								"border-emerald-400",
								"ring-2",
								"ring-emerald-200"
							);
							state.answers[i] = idx; // s√©lection imm√©diate (non valid√©e)
						});
						wrap.appendChild(card);
					});
					els.options.appendChild(wrap);
				}

				// Reset feedback
				els.feedback.classList.add("hidden");
				els.feedback.classList.remove(
					"bg-green-50",
					"text-green-800",
					"bg-amber-50",
					"text-amber-800",
					"bg-red-50",
					"text-red-800"
				);
				els.feedback.innerHTML = "";
				els.relevanceBox.classList.add("hidden");
				els.relevanceText.textContent = "";

				// Boutons / √©tats
				const isValidated = state.validated[i];
				els.prevBtn.disabled = i === 0;
				els.validateBtn.classList.toggle("hidden", isValidated);

				const isLast = i === QUESTIONS.length - 1;
				els.nextBtn.classList.toggle("hidden", isLast);
				els.nextBtn.disabled = !isValidated;
				els.finishBtn.classList.toggle("hidden", !(isValidated && isLast));

				// Verrouillage si d√©j√† valid√©e
				setInputsDisabled(isValidated);

				// Restaurer feedback si d√©j√† valid√©e
				if (isValidated) showFeedback();
			}

			/* ---------- Lecture de la s√©lection ---------- */
			function getCurrentSelection() {
				const i = state.index;
				const q = QUESTIONS[i];
				if (q.selectionType === "single") {
					const checked = els.options.querySelector(
						'input[type="radio"]:checked'
					);
					return checked ? Number(checked.value) : null;
				}
				if (q.selectionType === "multi") {
					const checked = [
						...els.options.querySelectorAll(
							'input[type="checkbox"]:checked'
						),
					].map((n) => Number(n.value));
					return checked.length ? checked : null;
				}
				if (q.selectionType === "select") {
					const sel = els.options.querySelector("select");
					if (!sel || sel.value === "") return null;
					return Number(sel.value);
				}
				if (q.selectionType === "multiselect") {
					const sel = els.options.querySelector("select");
					if (!sel) return null;
					const vals = [...sel.selectedOptions].map((o) =>
						Number(o.value)
					);
					return vals.length ? vals : null;
				}
				if (q.selectionType === "toggle") {
					const chk = els.options.querySelector(
						'input[type="checkbox"]#toggle_' + i
					);
					if (!chk) return null;
					return chk.checked ? 1 : 0;
				}
				if (q.selectionType === "range") {
					const r = els.options.querySelector('input[type="range"]');
					return r ? Number(r.value) : null;
				}
				if (q.selectionType === "ranking") {
					const items = [...els.options.querySelectorAll("li")];
					if (!items.length) return null;
					return items.map((li) => Number(li.dataset.idx));
				}
				if (q.selectionType === "image") {
					const current = state.answers[i];
					return Number.isInteger(current) ? current : null;
				}
				return null;
			}

			/* ---------- Points ---------- */
			function pointsForSelection(q, selection) {
				if (selection === null) return 0;
				switch (q.selectionType) {
					case "single":
					case "select":
					case "image": {
						const idx = selection;
						return q.options[idx]?.points ?? 0;
					}
					case "multi":
					case "multiselect": {
						return selection.reduce(
							(sum, idx) => sum + (q.options[idx]?.points ?? 0),
							0
						);
					}
					case "toggle": {
						const idx = selection; // 0 ou 1
						return q.options[idx]?.points ?? 0;
					}
					case "range": {
						const val = selection;
						const band = (q.range?.bands ?? []).find(
							(b) => val >= b.min && val <= b.max
						);
						return band ? band.points : 0;
					}
					case "ranking": {
						const order = selection; // tableau d'indices
						const expected = q.ranking?.correctOrder ?? [];
						const per = q.ranking?.pointsPerItem ?? 1;
						let good = 0;
						expected.forEach((idx, pos) => {
							if (order[pos] === idx) good += 1;
						});
						return good * per;
					}
					default:
						return 0;
				}
			}

			/* ---------- Feedback ---------- */
			function showFeedback() {
				const i = state.index;
				const q = QUESTIONS[i];
				const earned = state.pointsEarned[i];
				const maxP = maxPointsForQuestion(q);
				const ratio = maxP ? earned / maxP : 0;

				els.feedback.classList.remove("hidden");
				els.feedback.classList.toggle("bg-green-50", ratio === 1);
				els.feedback.classList.toggle("text-green-800", ratio === 1);
				els.feedback.classList.toggle(
					"bg-amber-50",
					ratio > 0 && ratio < 1
				);
				els.feedback.classList.toggle(
					"text-amber-800",
					ratio > 0 && ratio < 1
				);
				els.feedback.classList.toggle("bg-red-50", ratio === 0);
				els.feedback.classList.toggle("text-red-800", ratio === 0);

				let text = "";
				if (ratio === 1) {
					text = q.feedback_correct || "Super üëç";
				} else if (ratio === 0) {
					text = q.feedback_incorrect || "Pas de souci üôå";
				} else {
					text = q.feedback_partial || "Bien üòä";
				}
				els.feedback.innerHTML = `<div class="font-medium">${text}</div><div class="mt-1 text-gray-700">Points obtenus : <strong>${earned}</strong> / ${maxP}</div>`;

				els.relevanceBox.classList.remove("hidden");
				els.relevanceText.textContent = q.relevance || "";
			}

			/* ---------- Navigation & validation ---------- */
			function validate() {
				const i = state.index;
				const q = QUESTIONS[i];
				if (state.validated[i]) return;

				const sel = getCurrentSelection();
				if (sel === null) {
					els.options.classList.add("ring-2", "ring-red-300");
					setTimeout(
						() => els.options.classList.remove("ring-2", "ring-red-300"),
						500
					);
					return;
				}
				state.answers[i] = sel;
				const earned = pointsForSelection(q, sel);

				state.validated[i] = true;
				state.pointsEarned[i] = earned;
				state.score += earned;
				els.scoreLabel.textContent = `Score : ${state.score}`;

				setInputsDisabled(true);
				els.validateBtn.classList.add("hidden");

				const isLast = i === QUESTIONS.length - 1;
				if (isLast) {
					els.finishBtn.classList.remove("hidden");
					els.nextBtn.classList.add("hidden");
				} else {
					els.nextBtn.disabled = false;
					els.nextBtn.classList.remove("hidden");
				}

				showFeedback();
			}

			function nextQ() {
				if (state.index < QUESTIONS.length - 1) {
					state.index += 1;
					renderQuestion();
				}
			}
			function prevQ() {
				if (state.index > 0) {
					state.index -= 1;
					renderQuestion();
				}
			}

			/* ---------- Finalisation ---------- */
			function finalize() {
				const total = TOTAL_MAX;
				const score = state.score;
				const pct = Math.round((score / total) * 100);

				// Drapeaux doux (selon questions cl√©s)
				const flags = [];
				const bad = (id) => {
					const idx = QUESTIONS.findIndex((q) => q.id === id);
					if (idx < 0) return false;
					const maxP = maxPointsForQuestion(QUESTIONS[idx]);
					return (state.pointsEarned[idx] || 0) < maxP;
				};
				if (bad("IA12"))
					flags.push(
						"Confidentialit√© √† renforcer (limiter/masquer les donn√©es sensibles)."
					);
				if (bad("IA04") || bad("IA06"))
					flags.push(
						"Pensez √† v√©rifier les informations (hallucinations possibles)."
					);
				if (bad("IA08"))
					flags.push(
						"Structure des prompts √† pr√©ciser (objectif, contexte, format, exemple)."
					);

				// Verdict bienveillant
				let verdict = "";
				let style = "bg-blue-50 text-blue-900 border-blue-200";
				if (pct >= 75 && flags.length === 0) {
					verdict =
						"‚úÖ Tr√®s bon positionnement : vous pouvez aborder des ateliers pratiques sans difficult√©.";
					style = "bg-emerald-50 text-emerald-900 border-emerald-200";
				} else if (pct >= 55) {
					verdict =
						"üü° Bases solides : vous pouvez suivre la formation modeste, avec quelques rappels cibl√©s.";
					style = "bg-amber-50 text-amber-900 border-amber-200";
				} else if (pct >= 35) {
					verdict =
						"üü† Position interm√©diaire : un module d‚Äôinitiation suppl√©mentaire vous mettra parfaitement √† l‚Äôaise.";
					style = "bg-orange-50 text-orange-900 border-orange-200";
				} else {
					verdict =
						"üî¥ Recommandation : commencez par un module d‚Äôintroduction (vocabulaire, s√©curit√©, prompts de base).";
					style = "bg-red-50 text-red-900 border-red-200";
				}

				els.finalSummary.textContent = `Score : ${score} / ${total} (${pct} %)`;
				els.finalFlags.innerHTML = "";
				flags.forEach((f) => {
					const li = document.createElement("li");
					li.textContent = f;
					els.finalFlags.appendChild(li);
				});
				els.recos.className = `p-4 rounded-xl border ${style}`;
				els.recos.textContent = verdict;

				// R√©cap par question
				els.recap.innerHTML = "";
				QUESTIONS.forEach((q, idx) => {
					const maxP = maxPointsForQuestion(q);
					const earned = state.pointsEarned[idx] || 0;

					let displayAns = "(aucune r√©ponse)";
					const userAns = state.answers[idx];
					if (q.selectionType === "range" && typeof userAns === "number") {
						displayAns = String(userAns);
					} else if (
						q.selectionType === "ranking" &&
						Array.isArray(userAns)
					) {
						displayAns = userAns
							.map((i) => q.options[i].label)
							.join(" ‚Üí ");
					} else if (Array.isArray(userAns)) {
						displayAns = userAns
							.map((i) => q.options[i].label)
							.join(" ; ");
					} else if (Number.isInteger(userAns)) {
						displayAns = q.options[userAns]?.label ?? displayAns;
					}

					const bestLabels = (() => {
						if (q.selectionType === "ranking") {
							return (q.ranking?.correctOrder ?? [])
								.map((i) => q.options[i].label)
								.join(" ‚Üí ");
						}
						if (q.selectionType === "range") {
							const bands = q.range?.bands ?? [];
							const best = bands.reduce(
								(m, b) => (b.points > m.points ? b : m),
								{ points: -1 }
							);
							if (best.points < 0) return "(‚Äî)";
							return `Meilleure zone : ${best.min}‚Äì${best.max}`;
						}
						if (["multi", "multiselect"].includes(q.selectionType)) {
							return (
								q.options
									.filter((o) => (o.points ?? 0) > 0)
									.map((o) => o.label)
									.join(" ; ") || "(‚Äî)"
							);
						}
						return (
							q.options.reduce(
								(best, o) =>
									(o.points ?? 0) > (best.points ?? -1) ? o : best,
								{}
							).label || "(‚Äî)"
						);
					})();

					const ratio = maxP ? earned / maxP : 0;
					const good = ratio === 1;
					const mid = ratio > 0 && ratio < 1;
					const card = document.createElement("div");
					card.className = `p-3 rounded-xl border ${
						good
							? "bg-green-50 border-green-200"
							: mid
							? "bg-amber-50 border-amber-200"
							: "bg-red-50 border-red-200"
					}`;
					card.innerHTML = `
      <div class="text-xs uppercase tracking-wide text-gray-500">${
			q.theme
		}</div>
      <div class="font-medium mt-1">${idx + 1}. ${q.question}</div>
      <div class="mt-1 text-sm"><span class="font-semibold">Votre r√©ponse :</span> ${displayAns}</div>
      <div class="text-sm"><span class="font-semibold">Pistes pertinentes :</span> ${bestLabels}</div>
      <div class="text-sm mt-1"><span class="font-semibold">Points :</span> ${earned} / ${maxP}</div>
    `;
					els.recap.appendChild(card);
				});

				els.final.classList.remove("hidden");
				els.final.scrollIntoView({ behavior: "smooth", block: "start" });
			}

			/* ---------- Utilitaires ---------- */
			function restart() {
				state.index = 0;
				state.validated = Array(QUESTIONS.length).fill(false);
				state.answers = Array(QUESTIONS.length).fill(null);
				state.pointsEarned = Array(QUESTIONS.length).fill(0);
				state.score = 0;
				els.scoreLabel.textContent = `Score : 0`;
				els.final.classList.add("hidden");
				renderQuestion();
			}
			function exportAnswers() {
				const payload = {
					date: new Date().toISOString(),
					score: state.score,
					totalMax: TOTAL_MAX,
					percent: Math.round((state.score / TOTAL_MAX) * 100),
					answers: QUESTIONS.map((q, idx) => ({
						id: q.id,
						question: q.question,
						selectionType: q.selectionType,
						selected: Array.isArray(state.answers[idx])
							? state.answers[idx]
							: state.answers[idx] === null
							? null
							: state.answers[idx],
						selectedLabels: (() => {
							const a = state.answers[idx];
							if (q.selectionType === "range" && typeof a === "number")
								return [String(a)];
							if (q.selectionType === "ranking" && Array.isArray(a))
								return a.map((i) => q.options[i].label);
							if (Array.isArray(a))
								return a.map((i) => q.options[i].label);
							if (Number.isInteger(a))
								return [q.options[a]?.label ?? ""];
							return [];
						})(),
						earned: state.pointsEarned[idx],
						maxPoints: maxPointsForQuestion(q),
					})),
				};
				const blob = new Blob([JSON.stringify(payload, null, 2)], {
					type: "application/json",
				});
				const url = URL.createObjectURL(blob);
				const a = document.createElement("a");
				a.href = url;
				a.download = "resultat-test-ia-modeste.json";
				document.body.appendChild(a);
				a.click();
				URL.revokeObjectURL(url);
				a.remove();
			}

			/* ---------- Raccourcis clavier ---------- */
			document.addEventListener("keydown", (e) => {
				if (e.key === "ArrowRight") nextQ();
				if (e.key === "ArrowLeft") prevQ();
				if (e.key.toLowerCase() === "v") validate();
			});

			/* ---------- Boutons ---------- */
			els.prevBtn.addEventListener("click", prevQ);
			els.validateBtn.addEventListener("click", validate);
			els.nextBtn.addEventListener("click", nextQ);
			els.finishBtn.addEventListener("click", finalize);
			els.restartBtn.addEventListener("click", restart);
			els.exportBtn.addEventListener("click", exportAnswers);

			/* ---------- Init ---------- */
			renderQuestion();
		</script>
	</body>
</html>
